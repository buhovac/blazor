@page "/favorites"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject ifosup.Services.FavoritesService FavoritesService

<h1>Favorites</h1>

@if (_userId is null)
{
    <p>Loading user…</p>
}
else
{
    <section>
        <h2>My favorites</h2>

        @if (_favorites.Count == 0)
        {
            <p>No favorites yet.</p>
        }
        else
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Favorite</th>
                        <th>Temperature</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in _favorites)
                    {
                        var friendly = GetFriendlyLabel(f);

                        <tr>
                            <td style="min-width:260px;">
                                <input class="input"
                                       @bind="_edit[f.Id]"
                                       placeholder="@friendly" />

                                <div class="muted"
                                     style="font-size:12px; margin-top:6px;">
                                    @friendly
                                </div>
                            </td>

                            <td style="white-space:nowrap;">
                                <span class="badge">
                                    @(string.IsNullOrWhiteSpace(f.Note) ? "n/a" : f.Note)
                                </span>
                            </td>

                            <td style="white-space:nowrap;">
                                <button class="btn"
                                        @onclick="() => SaveAsync(f.Id)">
                                    Save
                                </button>

                                <button class="btn btn-danger"
                                        @onclick="() => DeleteAsync(f.Id)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (!string.IsNullOrWhiteSpace(_message))
        {
            <p>@_message</p>
        }
    </section>
}

@code {
    private string? _userId;

    private List<ifosup.Models.FavoriteItem> _favorites = new();

    // Sada edit buffer sadrži samo CustomTitle
    private readonly Dictionary<int, string?> _edit = new();

    private string? _message;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (_userId is not null)
            await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _favorites = await FavoritesService.GetForUserAsync(_userId!);

        _edit.Clear();
        foreach (var f in _favorites)
        {
            _edit[f.Id] = f.CustomTitle;
        }
    }

    private async Task SaveAsync(int favoriteId)
    {
        if (!_edit.TryGetValue(favoriteId, out var title))
        {
            _message = "Edit buffer not found.";
            return;
        }

        var existing = _favorites.FirstOrDefault(x => x.Id == favoriteId);
        if (existing is null)
        {
            _message = "Not found.";
            return;
        }

        var ok = await FavoritesService.UpdateAsync(
            userId: _userId!,
            favoriteId: favoriteId,
            customTitle: title,
            note: existing.Note // NOTE ostaje nepromijenjen
        );

        _message = ok ? "Saved." : "Not found / not owner.";
        await ReloadAsync();
    }

    private async Task DeleteAsync(int favoriteId)
    {
        var ok = await FavoritesService.RemoveAsync(_userId!, favoriteId);
        _message = ok ? "Deleted." : "Not found / not owner.";
        await ReloadAsync();
    }

    private static string GetFriendlyLabel(ifosup.Models.FavoriteItem f)
    {
        // 1️⃣ SnapshotJson je najtočniji izvor
        if (!string.IsNullOrWhiteSpace(f.SnapshotJson))
        {
            try
            {
                using var doc = System.Text.Json.JsonDocument.Parse(f.SnapshotJson);
                var root = doc.RootElement;

                var city = root.TryGetProperty("City", out var cityEl)
                    ? cityEl.GetString()
                    : "Brussels";

                var time = root.TryGetProperty("Time", out var timeEl)
                    ? timeEl.GetString()
                    : null;

                if (!string.IsNullOrWhiteSpace(time) &&
                    DateTime.TryParse(time, out var dt))
                {
                    return $"{city} {dt:dd/MM HH:mm}";
                }

                return city ?? "Favorite";
            }
            catch
            {
                // ignore parsing errors
            }
        }

        // 2️⃣ Fallback: parsiraj iz ExternalId
        var idx = f.ExternalId.LastIndexOf(':');
        if (idx >= 0 && idx + 1 < f.ExternalId.Length)
        {
            var maybeTime = f.ExternalId[(idx + 1)..];

            if (DateTime.TryParse(maybeTime, out var dt))
                return $"Brussels {dt:dd/MM HH:mm}";
        }

        return "Favorite";
    }
}
