@page "/apiweather"
@rendermode InteractiveServer

@using ifosup.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization

@inject ifosup.Services.OpenMeteoClient Api
@inject AuthenticationStateProvider AuthStateProvider
@inject ifosup.Services.FavoritesService FavoritesService

<h1>Brussels Weather</h1>

@if (_isLoading)
{
    <p>Loading…</p>
}
else if (_error is not null)
{
    <p style="color:crimson">Error: @_error</p>
}
else if (_data is null)
{
    <p>No data.</p>
}
else
{
    <section style="margin-bottom: 1rem;">
        <h2>Current</h2>
        <ul>
            <li>Timezone: @_data.Timezone</li>
            <li>Date: @FormatDateForUi(_data.Current?.Time)</li>
            <li>Temperature: @FormatTemp(_data.Current?.Temperature2m)</li>
            <li>Wind: @FormatWind(_data.Current?.WindSpeed10m)</li>
        </ul>
    </section>

    <section>
        <h2>Next hours (temperature)</h2>

        @if (_hourRows.Count == 0)
        {
            <p>No hourly forecast available.</p>
        }
        else
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Temp</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var row in _hourRows)
                {
                    var externalId = $"openmeteo:brussels:hourly:{row.Time}";
                    var isAdded = _added.Contains(externalId);

                    <tr>
                        <td>@FormatTimeForUi(row.Time)</td>
                        <td>@row.TempC</td>
                        <td>
                            @if (_isAuthenticated)
                            {
                                <button class="btn @(isAdded ? "btn-warn" : "btn-primary")"
                                        disabled="@isAdded"
                                        @onclick="() => AddHourToFavoritesAsync(row)">
                                    @(isAdded ? "Added" : "Add to favorites")
                                </button>
                            }
                            else
                            {
                                <a href="/Identity/Account/Login" class="btn">Login</a>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>

            @if (!string.IsNullOrWhiteSpace(_favMessage))
            {
                <p>@_favMessage</p>
            }
        }
    </section>
}

@code {
    private OpenMeteoForecastResponse? _data;
    private bool _isLoading = true;
    private string? _error;

    private string? _userId;
    private bool _isAuthenticated;
    private string? _favMessage;

    private readonly List<HourRow> _hourRows = new();
    private readonly HashSet<string> _added = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;

            // 1) Fetch API
            _data = await Api.GetBrusselsForecastAsync();
            if (_data is not null)
                BuildHourRows(_data);

            // 2) Auth state
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            _isAuthenticated = user.Identity?.IsAuthenticated == true;
            _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

            // 3) Preload favorites => “Added” state persists after refresh
            if (_isAuthenticated && !string.IsNullOrWhiteSpace(_userId))
            {
                var favs = await FavoritesService.GetForUserAsync(_userId);
                _added.Clear();
                foreach (var f in favs)
                    _added.Add(f.ExternalId);
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void BuildHourRows(OpenMeteoForecastResponse data)
    {
        _hourRows.Clear();

        var times = data.Hourly?.Time ?? new();
        var temps = data.Hourly?.Temperature2m ?? new();

        var count = Math.Min(times.Count, temps.Count);

        for (var i = 0; i < count && i < 24; i++)
        {
            _hourRows.Add(new HourRow(times[i], $"{temps[i]:0.#} °C"));
        }
    }

    private async Task AddHourToFavoritesAsync(HourRow row)
    {
        _favMessage = null;

        if (!_isAuthenticated || string.IsNullOrWhiteSpace(_userId))
        {
            _favMessage = "Not authenticated.";
            return;
        }

        var externalId = $"openmeteo:brussels:hourly:{row.Time}";

        // UI-only guard (brže nego roundtrip)
        if (_added.Contains(externalId))
        {
            _favMessage = "Already in favorites.";
            return;
        }

        var snapshot = new
        {
            Source = "OpenMeteo",
            City = "Brussels",
            Type = "HourlyTemperature",
            Time = row.Time,
            Temp = row.TempC
        };

        var ok = await FavoritesService.AddAsync(
            userId: _userId,
            externalId: externalId,
            customTitle: $"Brussels {row.Time}",
            note: row.TempC,
            snapshotObject: snapshot
        );

        if (ok)
        {
            _added.Add(externalId); // <-- ključ da gumb postane “Added”
            _favMessage = "Added to favorites.";
        }
        else
        {
            _favMessage = "Already in favorites.";
        }
    }

    private static string FormatTimeForUi(string isoLike)
    {
        if (DateTime.TryParse(isoLike, out var dt))
            return dt.ToString("HH:mm"); // 24h, ponoć = 00:00

        var tIndex = isoLike.IndexOf('T');
        if (tIndex >= 0 && isoLike.Length >= tIndex + 3)
            return isoLike[(tIndex + 1)..];

        return isoLike;
    }

    private static string FormatDateForUi(string? isoLike)
    {
        if (string.IsNullOrWhiteSpace(isoLike))
            return "n/a";

        if (DateTime.TryParse(isoLike, out var dt))
            return dt.ToString("dd/MM");

        return isoLike;
    }


    private static string FormatTemp(double? t) => t is null ? "n/a" : $"{t:0.#} °C";
    private static string FormatWind(double? w) => w is null ? "n/a" : $"{w:0.#} km/h";

    private sealed record HourRow(string Time, string TempC);
}
